networks:
  rtos:
    driver: bridge

volumes:
  pgdata:

services:
  # ========= INFRA =========
  postgres:
    image: postgres:16
    container_name: dev-postgres
    env_file: ./.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports: ["${POSTGRES_PORT}:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks: [rtos]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: dev-redis
    env_file: ./.env
    ports: ["${REDIS_PORT}:6379"]
    networks: [rtos]
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    container_name: dev-rabbitmq
    env_file: ./.env
    environment:
      RABBITMQ_LOAD_DEFINITIONS: /etc/rabbitmq/definitions.json
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "5672:5672"
      - "15672:15672"
      - "15692:15692"
    volumes:
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 10s
      timeout: 5s
      start_period: 40s
      retries: 20
    networks: [ rtos ]
    restart: unless-stopped

  # ========= APP SERVICES =========
  order-service:
    build:
      context: ../backend
      dockerfile: order-service/Dockerfile
    image: rtos/order-service:dev
    container_name: order-service
    env_file: ./.env
    environment:
      # App profile & HTTP
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      PORT: ${ORDER_HTTP_PORT}

      # DB
      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PASS: ${POSTGRES_PASSWORD}

      # Rabbit — mevcut RABBIT_* değişkenlerin korunuyor
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}

      # Spring tarafı SPRING_RABBITMQ_* okuyorsa yedek olarak veriyoruz
      SPRING_RABBITMQ_HOST: ${RABBIT_HOST}
      SPRING_RABBITMQ_PORT: ${RABBIT_PORT}
      SPRING_RABBITMQ_USERNAME: ${RABBIT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBIT_PASS}

      # Auth
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      postgres: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
    ports: ["${ORDER_HTTP_PORT}:8081"]
    networks: [rtos]
    restart: unless-stopped

  notification-service:
    build:
      context: ../backend
      dockerfile: notification-service/Dockerfile
    image: rtos/notification-service:dev
    container_name: notification-service
    env_file: ./.env
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      PORT: ${NOTIFICATION_HTTP_PORT}

      # Rabbit
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}

      SPRING_RABBITMQ_HOST: ${RABBIT_HOST}
      SPRING_RABBITMQ_PORT: ${RABBIT_PORT}
      SPRING_RABBITMQ_USERNAME: ${RABBIT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBIT_PASS}

      # Auth
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      rabbitmq: { condition: service_healthy }
    ports: ["${NOTIFICATION_HTTP_PORT}:8082"]
    networks: [rtos]
    restart: unless-stopped

  inventory-service:
    build:
      context: ../backend
      dockerfile: inventory-service/Dockerfile
    image: rtos/inventory-service:dev
    container_name: inventory-service
    env_file: ./.env
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      PORT: ${INVENTORY_HTTP_PORT}

      # DB
      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PASS: ${POSTGRES_PASSWORD}

      # Rabbit
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}

      SPRING_RABBITMQ_HOST: ${RABBIT_HOST}
      SPRING_RABBITMQ_PORT: ${RABBIT_PORT}
      SPRING_RABBITMQ_USERNAME: ${RABBIT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBIT_PASS}

      # Auth
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      postgres: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
    ports: ["${INVENTORY_HTTP_PORT}:8083"]
    networks: [rtos]
    restart: unless-stopped

  reporting-service:
    build:
      context: ../backend
      dockerfile: reporting-service/Dockerfile
    image: rtos/reporting-service:dev
    container_name: reporting-service
    env_file: ./.env
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      PORT: ${REPORTING_HTTP_PORT}

      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PASS: ${POSTGRES_PASSWORD}

      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      APP_REPORTING_CACHE_PROVIDER: ${APP_REPORTING_CACHE_PROVIDER:-caffeine}

      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}
      SPRING_RABBITMQ_HOST: ${RABBIT_HOST}
      SPRING_RABBITMQ_PORT: ${RABBIT_PORT}
      SPRING_RABBITMQ_USERNAME: ${RABBIT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBIT_PASS}

      JWT_SECRET: ${JWT_SECRET}
      ORDER_EVENTS_EXCHANGE: order.events
      REPORTING_ORDER_CREATED_QUEUE: dev.reporting.order-created
      ORDER_EVENTS_ROUTING_CREATED: order.created.v1
    depends_on:
      postgres: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
    ports: ["${REPORTING_HTTP_PORT}:8084"]
    networks: [rtos]
    restart: unless-stopped

  # ========= OBSERVABILITY =========
  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: dev-prometheus
    ports: ["9090:9090"]
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-lifecycle
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/alerts.yml:/etc/prometheus/alerts.yml:ro
    networks: [rtos]
    depends_on:
      - order-service
      - inventory-service
      - notification-service
      - reporting-service
      - rabbitmq
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.2.0
    container_name: dev-grafana
    ports: [ "3000:3000" ]
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_DEFAULT_THEME: dark
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes:
      - ./observability/grafana-datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml:ro
      - ./observability/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/rtos-provider.yml:ro
      - ./observability/dashboards/reporting-overview.json:/var/lib/grafana/dashboards/reporting-overview.json:ro
      - ./observability/dashboards/rtos-services.json:/var/lib/grafana/dashboards/rtos-services.json:ro
    networks: [ rtos ]
    depends_on:
      - prometheus
    restart: unless-stopped
